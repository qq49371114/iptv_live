# organize_live.yml v4.4
# 机器人管家：自动整理直播源
# 作者：婉儿 & 哥哥

name: 自动整理直播源

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # 每天北京时间早上8点运行

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp

      - name: 运行整理程序
        run: |
          SOURCES_WITH_GROUP=""
          
          # 第一部分：处理本地 sources/ 文件夹，这部分逻辑是好的，我们保留
          if [ -d "sources" ]; then
            for file in sources/*; do
              if [ -f "$file" ]; then
                GROUP_NAME=$(basename "$file" | sed 's/\.[^.]*$//')
                SOURCES_WITH_GROUP="$SOURCES_WITH_GROUP $file:$GROUP_NAME"
              fi
            done
          fi
          
          # ✨ 婉儿的终极修复：用更安全的方式来读取和处理外部源！
          if [ -f "sources.txt" ]; then
            # 我们不再用那个复杂的管道命令了，我们用一个更稳妥的while read循环
            while IFS= read -r url || [ -n "$url" ]; do
              # 忽略空行和注释行
              [[ "$url" =~ ^# ]] || [[ -z "$url" ]] && continue
              # 把每一个完整的URL，都追加到我们的参数列表里
              SOURCES_WITH_GROUP="$SOURCES_WITH_GROUP $url:网络源"
            done < sources.txt
          fi

          # 最后，执行我们的Python脚本
          python -u m3u8_organizer.py \
            -i $SOURCES_WITH_GROUP \
            --epg-url "http://epg.51zmt.top:8000/e.xml" \
            -b config/blacklist.txt \
            -f config/favorites.txt \
            -o dist/live

      - name: 提交更新的文件
        uses: EndBug/add-and-commit@v9
        with:
          token: ${{ secrets.ACTIONS_PAT }}
          add: 'dist'
          author_name: 'Waner-Bot'
          author_email: 'waner-bot@users.noreply.github.com'
          message: 'chore: 自动更新直播源'

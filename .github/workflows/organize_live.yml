# organize_live.yml v4.1 - 终极自动化版
# 机器人管家：自动整理直播源
# 作者：婉儿 & 哥哥

name: 自动整理直播源

on:
  # 允许手动触发
  workflow_dispatch:
  # 定时任务：每天北京时间早上8点运行一次 (UTC时间是0点)
  schedule:
    - cron: '0 0 * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码，这样才能读取到我们的py脚本和所有配置文件
      - name: 检出代码
        uses: actions/checkout@v4

      # 2. 设置Python环境
      - name: 设置Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3. 安装我们脚本需要的“零件”
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp

      # 4. ✨ 核心步骤：运行我们的Python脚本！
      - name: 运行整理程序
        run: |
          # ✨ 婉儿的终极魔法：自动生成“源:分组”参数列表！
          SOURCES_WITH_GROUP=""
          
          # ✨ 第一步：处理 sources/ 文件夹下的所有本地源
          if [ -d "sources" ]; then
            for file in sources/*; do
              if [ -f "$file" ]; then
                # 从文件名中提取出分组名 (去掉.txt或.m3u后缀)
                GROUP_NAME=$(basename "$file" | sed 's/\.[^.]*$//')
                SOURCES_WITH_GROUP="$SOURCES_WITH_GROUP $file:$GROUP_NAME"
              fi
            done
          fi
          
          # ✨ 第二步：处理根目录下的 sources.txt 里的外部源，统一归为“网络源”分组
          if [ -f "sources.txt" ]; then
            # 读取文件时，过滤掉空行和注释行
            EXTERNAL_SOURCES=$(cat sources.txt | grep -v '^#' | grep -v '^$' | tr '\n' ' ')
            for url in $EXTERNAL_SOURCES; do
              SOURCES_WITH_GROUP="$SOURCES_WITH_GROUP $url:网络源"
            done
          fi

          # ✨ 第三步：把所有参数都传给我们的Python脚本！
          #    加上 -u 参数，强制Python实时打印日志，方便我们调试！
          python -u m3u8_organizer.py \
            -i $SOURCES_WITH_GROUP \
            --epg-url "http://epg.51zmt.top:8000/e.xml" \
            -b config/blacklist.txt \
            -f config/favorites.txt \
            -o dist/live

      # 5. 把新生成的文件提交回GitHub仓库
      - name: 提交更新的文件
        uses: EndBug/add-and-commit@v9
        with:
          # ✨ 使用我们自己的“私人令牌”来获取最高权限！
          token: ${{ secrets.ACTIONS_PAT }}
          add: 'dist'
          author_name: 'Waner-Bot'
          author_email: 'waner-bot@users.noreply.github.com'
          message: 'chore: 自动更新直播源'

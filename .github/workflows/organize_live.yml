# organize_live.yml v4.4
# 机器人管家：自动整理直播源
# 作者：婉儿 & 哥哥

name: 自动整理直播源

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # 每天北京时间早上8点运行

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp

      - name: 运行整理程序
        run: |
          SOURCES_WITH_GROUP=""
          if [ -d "sources" ]; then
            for file in sources/*; do
              if [ -f "$file" ]; then
                GROUP_NAME=$(basename "$file" | sed 's/\.[^.]*$//')
                SOURCES_WITH_GROUP="$SOURCES_WITH_GROUP $file:$GROUP_NAME"
              fi
            done
          fi
          
          if [ -f "sources.txt" ]; then
            EXTERNAL_SOURCES=$(cat sources.txt | grep -v '^#' | grep -v '^$' | tr '\n' ' ')
            for url in $EXTERNAL_SOURCES; do
              SOURCES_WITH_GROUP="$SOURCES_WITH_GROUP $url:网络源"
            done
          fi

          python -u m3u8_organizer.py \
            -i $SOURCES_WITH_GROUP \
            --epg-url "http://epg.51zmt.top:8000/e.xml" \
            -b config/blacklist.txt \
            -f config/favorites.txt \
            -o dist/live

      - name: 提交更新的文件
        uses: EndBug/add-and-commit@v9
        with:
          token: ${{ secrets.ACTIONS_PAT }}
          add: 'dist'
          author_name: 'Waner-Bot'
          author_email: 'waner-bot@users.noreply.github.com'
          message: 'chore: 自动更新直播源'
